{% extends "base.html" %}

{% block content %}

<div id="path-header">
    å½“å‰è·¯å¾„: <b id="current-path-display">/</b>
</div>

<div class="tree-wrapper">
    <div id="tree-container">
    </div>
</div>

<style>
    /* å…è®¸æ°´å¹³æ»šåŠ¨ */
    body {
        overflow-x: auto;
    }
    .tree-wrapper {
        min-width: min-content;
        padding-bottom: 20px;
    }

    /* è·¯å¾„æ ‡é¢˜æ ·å¼ */
    #path-header {
        font-size: 1.1em;
        font-family: monospace;
        padding: 10px 5px;
        background-color: #f4f4f4;
        border-bottom: 1px solid #ddd;
        margin-bottom: 10px;
    }

    /* åŸºç¡€æ ‘å½¢æ ·å¼ï¼šè®¾ç½®ä¸€ä¸ªéå¸¸å°çš„ç¼©è¿›å€¼ */
    #tree-container ul {
        list-style-type: none;
        margin-left: 0px;
    }

    #tree-container ul ul {
        margin-left: 10px;
    }

    #tree-container li {
        position: relative;
        white-space: nowrap;
        margin-left: 0px;
    }

    /* æ–‡ä»¶å¤¹å’Œæ–‡ä»¶çš„ç‰¹å®šæ ·å¼ */
    .folder > .name, .folder > .toggle {
        cursor: pointer;
    }
    .folder .toggle {
        font-weight: bold;
        display: inline-block;
        user-select: none;
    }
    .file .icon {
        display: inline-block;
        color: #666;
    }
    .file .size {
        color: #888;
        padding-left: 10px;
        font-size: 0.9em;
    }

    /* å¤åˆ¶é“¾æ¥æ ·å¼ */
    .copy-link {
        display: inline-block;
        margin-left: 8px;
        cursor: pointer;
        font-size: 0.9em;
        visibility: hidden;
        opacity: 0.5;
        transition: opacity 0.2s, visibility 0.2s;
    }
    li.folder:hover .copy-link {
        visibility: visible;
        opacity: 0.7;
    }
    .copy-link:hover {
        opacity: 1;
    }
    .copy-link.copied {
        color: green;
        opacity: 1;
        visibility: visible;
    }

    /* å±•å¼€/æŠ˜å çš„æ ¸å¿ƒé€»è¾‘ */
    #tree-container li > .nested {
        display: none;
    }
    #tree-container li.expanded > .nested {
        display: block;
    }
</style>

<script lang="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // --- JavaScript ä»£ç ä¿æŒä¸å˜ ---
        const treeContainer = document.getElementById('tree-container');
        const urlParams = new URLSearchParams(window.location.search);

        const initialPath = urlParams.get('path') || '/';

        const pathDisplay = document.getElementById('current-path-display');
        if (pathDisplay) {
            pathDisplay.textContent = initialPath;
        }

        const rootUl = document.createElement('ul');
        treeContainer.appendChild(rootUl);

        function loadDirectory(path, containerUl) {
            const apiUrl = `https://lbepan.luoboedu.com?path=${encodeURIComponent(path)}`;

            if (!containerUl.dataset.loaded) {
                 containerUl.innerHTML = '<li>åŠ è½½ä¸­...</li>';
            }

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    containerUl.innerHTML = '';

                    if (!data.list || data.list.length === 0) {
                        containerUl.innerHTML = '<li>(ç©º)</li>';
                        return;
                    }

                    data.list.forEach(item => {
                        const li = document.createElement('li');

                        if (item.is_dir) {
                            li.classList.add('folder');
                            const newPath = path.endsWith('/') ? `${path}${item.name}` : `${path}/${item.name}`;
                            li.dataset.path = newPath;

                            li.innerHTML = `
                                <span class="toggle">+</span>
                                <span class="name">ğŸ“ ${item.name || ''}</span>
                                <span class="copy-link" title="å¤åˆ¶é“¾æ¥">ğŸ”—</span>
                                <ul class="nested"></ul>
                            `;
                        } else {
                            li.classList.add('file');
                            li.innerHTML = `
                                <span class="icon">ğŸ“„</span>
                                <span class="name">${item.name || ''}</span>
                                <span class="size">(${item.size || ''})</span>
                            `;
                        }
                        containerUl.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    containerUl.innerHTML = `<li style="color: red;">åŠ è½½å¤±è´¥: ${error.message}</li>`;
                });
        }

        treeContainer.addEventListener('click', function(e) {

            const copyLink = e.target.closest('.copy-link');
            if (copyLink) {
                const li = copyLink.closest('li.folder');
                const path = li.dataset.path;

                const url = new URL(window.location.pathname, window.location.origin);
                url.searchParams.set('path', path);
                const shareUrl = url.toString();

                navigator.clipboard.writeText(shareUrl).then(() => {
                    copyLink.textContent = 'âœ…';
                    copyLink.classList.add('copied');
                    setTimeout(() => {
                        copyLink.textContent = 'ğŸ”—';
                        copyLink.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('æ— æ³•å¤åˆ¶é“¾æ¥: ', err);
                    alert('å¤åˆ¶å¤±è´¥!');
                });
                return;
            }

            const targetElement = e.target.closest('.toggle, .name');
            if (!targetElement) return;

            const li = targetElement.closest('li.folder');
            if (!li) return;

            const toggle = li.querySelector('.toggle');
            const nestedUl = li.querySelector('.nested');
            if (!toggle || !nestedUl) return;

            const isExpanded = li.classList.toggle('expanded');

            if (isExpanded) {
                toggle.textContent = 'âˆ’';
                if (!nestedUl.dataset.loaded) {
                    const path = li.dataset.path;
                    loadDirectory(path, nestedUl);
                    nestedUl.dataset.loaded = 'true';
                }
            } else {
                toggle.textContent = '+';
            }
        });

        loadDirectory(initialPath, rootUl);

    });
</script>
{% endblock %}