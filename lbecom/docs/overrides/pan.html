{% extends "base.html" %}

{% block content %}

<div id="path-header">
    å½“å‰è·¯å¾„: <b id="current-path-display">/</b>
</div>

<div id="tree-container">
    </div>

<style>
    /* ... æ‚¨çš„æ‰€æœ‰æ ‘å½¢æ ·å¼ ... */

    /* æ–°å¢ï¼šè·¯å¾„æ ‡é¢˜æ ·å¼ */
    #path-header {
        font-size: 1.1em;
        font-family: monospace; /* ç­‰å®½å­—ä½“æ›´é€‚åˆæ˜¾ç¤ºè·¯å¾„ */
        padding: 10px 5px;
        background-color: #f4f4f4;
        border-bottom: 1px solid #ddd;
        margin-bottom: 10px;
    }

    /* åŸºç¡€æ ‘å½¢æ ·å¼ */
    #tree-container ul {
        list-style-type: none;
        padding-left: 20px;
    }
    #tree-container li {
        padding: 4px 0;
        position: relative;
    }

    /* æ–‡ä»¶å¤¹å’Œæ–‡ä»¶çš„ç‰¹å®šæ ·å¼ */
    .folder > .name, .folder > .toggle {
        cursor: pointer;
    }
    .folder .toggle {
        font-weight: bold;
        display: inline-block;
        width: 1.2em;
        user-select: none;
    }
    .file .icon {
        display: inline-block;
        width: 1.2em;
        color: #666;
    }
    .file .size {
        color: #888;
        padding-left: 10px;
        font-size: 0.9em;
    }

    /* å¤åˆ¶é“¾æ¥æ ·å¼ */
    .copy-link {
        display: inline-block;
        margin-left: 8px;
        cursor: pointer;
        font-size: 0.9em;
        visibility: hidden;
        opacity: 0.5;
        transition: opacity 0.2s, visibility 0.2s;
    }
    li.folder:hover .copy-link {
        visibility: visible;
        opacity: 0.7;
    }
    .copy-link:hover {
        opacity: 1;
    }
    .copy-link.copied {
        color: green;
        opacity: 1;
        visibility: visible;
    }

    /* å±•å¼€/æŠ˜å çš„æ ¸å¿ƒé€»è¾‘ (å·²ä¿®å¤) */
    #tree-container li > .nested {
        display: none;
    }
    #tree-container li.expanded > .nested {
        display: block;
    }
</style>

<script lang="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const treeContainer = document.getElementById('tree-container');
        const urlParams = new URLSearchParams(window.location.search);

        // è¿™ç°åœ¨æ˜¯æ­¤é¡µé¢çš„ "æ ¹" è·¯å¾„
        const initialPath = urlParams.get('path') || '/';

        // --- æ–°å¢ï¼šæ›´æ–°è·¯å¾„æ ‡é¢˜ ---
        const pathDisplay = document.getElementById('current-path-display');
        if (pathDisplay) {
            pathDisplay.textContent = initialPath;
        }
        // --- ç»“æŸ ---

        const rootUl = document.createElement('ul');
        treeContainer.appendChild(rootUl);

        /**
         * æ ¸å¿ƒå‡½æ•°ï¼šåŠ è½½å¹¶æ¸²æŸ“æŒ‡å®šè·¯å¾„çš„ç›®å½•å†…å®¹
         * @param {string} path - è¦åŠ è½½çš„ç›®å½•è·¯å¾„
         * @param {HTMLElement} containerUl - ç”¨äºå¡«å……å†…å®¹çš„ <ul> å…ƒç´ 
         */
        function loadDirectory(path, containerUl) {
            const apiUrl = `https://lbepan.luoboedu.com?path=${encodeURIComponent(path)}`;

            if (!containerUl.dataset.loaded) {
                 containerUl.innerHTML = '<li>åŠ è½½ä¸­...</li>';
            }

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    containerUl.innerHTML = '';

                    if (!data.list || data.list.length === 0) {
                        containerUl.innerHTML = '<li>(ç©º)</li>';
                        return;
                    }

                    data.list.forEach(item => {
                        const li = document.createElement('li');

                        // å‡è®¾ 'is_dir: true'
                        if (item.is_dir) {
                            li.classList.add('folder');
                            // å…³é”®ï¼šè·¯å¾„æ˜¯åŸºäº *å½“å‰* è·¯å¾„æ„å»ºçš„
                            const newPath = path.endsWith('/') ? `${path}${item.name}` : `${path}/${item.name}`;
                            li.dataset.path = newPath;

                            li.innerHTML = `
                                <span class="toggle">+</span>
                                <span class="name">ğŸ“ ${item.name || ''}</span>
                                <span class="copy-link" title="å¤åˆ¶é“¾æ¥">ğŸ”—</span>
                                <ul class="nested"></ul>
                            `;
                        } else {
                            li.classList.add('file');
                            li.innerHTML = `
                                <span class="icon">ğŸ“„</span>
                                <span class="name">${item.name || ''}</span>
                                <span class="size">(${item.size || ''})</span>
                            `;
                        }
                        containerUl.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    containerUl.innerHTML = `<li style="color: red;">åŠ è½½å¤±è´¥: ${error.message}</li>`;
                });
        }

        // --- äº‹ä»¶å§”æ‰˜ (æ— éœ€æ›´æ”¹) ---
        treeContainer.addEventListener('click', function(e) {

            // 1. å¤„ç† "å¤åˆ¶é“¾æ¥"
            const copyLink = e.target.closest('.copy-link');
            if (copyLink) {
                const li = copyLink.closest('li.folder');
                const path = li.dataset.path;

                const url = new URL(window.location.pathname, window.location.origin);
                url.searchParams.set('path', path);
                const shareUrl = url.toString();

                navigator.clipboard.writeText(shareUrl).then(() => {
                    copyLink.textContent = 'âœ…';
                    copyLink.classList.add('copied');
                    setTimeout(() => {
                        copyLink.textContent = 'ğŸ”—';
                        copyLink.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('æ— æ³•å¤åˆ¶é“¾æ¥: ', err);
                    alert('å¤åˆ¶å¤±è´¥!');
                });
                return; // ç»“æŸ
            }

            // 2. å¤„ç† "æŠ˜å /å±•å¼€"
            const targetElement = e.target.closest('.toggle, .name');
            if (!targetElement) return;

            const li = targetElement.closest('li.folder');
            if (!li) return;

            const toggle = li.querySelector('.toggle');
            const nestedUl = li.querySelector('.nested');
            if (!toggle || !nestedUl) return;

            const isExpanded = li.classList.toggle('expanded');

            if (isExpanded) {
                toggle.textContent = 'âˆ’';
                if (!nestedUl.dataset.loaded) {
                    const path = li.dataset.path;
                    loadDirectory(path, nestedUl); // åŠ¨æ€åŠ è½½å­ç›®å½•
                    nestedUl.dataset.loaded = 'true';
                }
            } else {
                toggle.textContent = '+';
            }
        });

        // --- å…³é”®ä¿®æ”¹ ---
        // ç§»é™¤äº†æ‰€æœ‰å¤æ‚çš„ "auto-expand" é€»è¾‘
        // åªéœ€æ ¹æ® initialPath åŠ è½½ "æ ¹" ç›®å½•
        loadDirectory(initialPath, rootUl);

    });
</script>
{% endblock %}