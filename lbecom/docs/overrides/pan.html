{% extends "base.html" %}

{% block content %}
<div id="path-header">
    å½“å‰è·¯å¾„: <b id="current-path-display">/</b>
</div>

<div class="tree-wrapper">
    <div id="tree-container">
    </div>
</div>

<style>
    /* å…è®¸æ°´å¹³æ»šåŠ¨ */
    body {
        overflow-x: auto;
    }
    .tree-wrapper {
        min-width: min-content;
        padding-bottom: 20px;
    }

    /* è·¯å¾„æ ‡é¢˜æ ·å¼ */
    #path-header {
        font-size: 1.1em;
        font-family: monospace;
        padding: 10px 5px;
        background-color: #f4f4f4;
        border-bottom: 1px solid #ddd;
        margin-bottom: 10px;
    }

    /* åŸºç¡€æ ‘å½¢æ ·å¼ï¼šè®¾ç½®ä¸€ä¸ªéå¸¸å°çš„ç¼©è¿›å€¼ */
    #tree-container ul {
        list-style-type: none;
        margin-left: 0px;
    }

    #tree-container ul ul {
        margin-left: 10px;
    }

    #tree-container li {
        position: relative;
        white-space: nowrap;
        margin-left: 0px;
    }

    /* æ–‡ä»¶å¤¹å’Œæ–‡ä»¶çš„ç‰¹å®šæ ·å¼ */
    .folder > .name, .folder > .toggle {
        cursor: pointer;
    }
    .folder .toggle {
        font-weight: bold;
        display: inline-block;
        user-select: none;
    }

    /* --- æ ¸å¿ƒä¼˜åŒ–: SVG å›¾æ ‡å®¹å™¨æ ·å¼ --- */
    .file .icon, .icon-folder {
        /* twemoji ç±»æ ·å¼ï¼šå†…è” flex/block, å±…ä¸­ */
        display: inline-flex;
        align-items: center;
        width: 1.2em;
        height: 1.2em;
        vertical-align: middle;
        margin-right: 3px;
    }
    .file .icon {
        color: #666; /* é»˜è®¤é¢œè‰² */
    }
    /* SVG å…ƒç´ è‡ªèº«çš„æ ·å¼ */
    .file .icon svg, .icon-folder svg {
        width: 100%;
        height: 100%;
        fill: currentColor; /* ç¡®ä¿ SVG ä½¿ç”¨çˆ¶å®¹å™¨çš„é¢œè‰² */
    }

    .file .size {
        color: #888;
        padding-left: 10px;
        font-size: 0.9em;
    }

    /* å¤åˆ¶é“¾æ¥æ ·å¼ */
    .copy-link {
        display: inline-block;
        margin-left: 8px;
        cursor: pointer;
        font-size: 0.9em;
        visibility: hidden;
        opacity: 0.5;
        transition: opacity 0.2s, visibility 0.2s;
    }
    li.folder:hover .copy-link {
        visibility: visible;
        opacity: 0.7;
    }
    .copy-link:hover {
        opacity: 1;
    }
    .copy-link.copied {
        color: green;
        opacity: 1;
        visibility: visible;
    }

    /* å±•å¼€/æŠ˜å çš„æ ¸å¿ƒé€»è¾‘ */
    #tree-container li > .nested {
        display: none;
    }
    #tree-container li.expanded > .nested {
        display: block;
    }

    /* è¾…åŠ©æ€§çš„é¢œè‰²ç±»ï¼ˆæœªä¿®æ”¹æ‚¨åŸæœ‰çš„CSSï¼‰ */
    .icon-pdf { color: #E53935; }
    .icon-img { color: #4CAF50; }
    .icon-vid { color: #9C27B0; }
    .icon-code { color: #FF9800; }
    .icon-txt { color: #757575; }
    .icon-folder { color: orange; } /* æ–‡ä»¶å¤¹å›¾æ ‡é¢œè‰² */

</style>

<script lang="javascript">
    // ç«‹å³æ‰§è¡Œå‡½æ•°è¡¨è¾¾å¼ (IIFE) å°è£…æ‰€æœ‰å¸¸é‡å’Œè¾…åŠ©å‡½æ•°
    (function() {

        // --- 1. å±€éƒ¨å¸¸é‡å’Œè¾…åŠ©å‡½æ•°å®šä¹‰ (ä»…åœ¨ IIFE å†…éƒ¨å£°æ˜å’Œä½¿ç”¨) ---

        const SVG_ICONS = {
            'folder-regular': '<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M42.688 106.688H404.48l85.312 106.624h491.52V896H42.624V106.688zM128 192v618.688h768v-512H448.832L363.52 192H128z" p-id="17028"></path></svg>',
            'file-regular': '<svg viewBox="0 0 384 512"><path d="M368 152.8V48c0-13.3-10.7-24-24-24s-24 10.7-24 24V144c0 13.3 10.7 24 24 24h112c13.3 0 24-10.7 24-24V152.8zm-208 0V48H189.1c11.3 0 22.3 4.4 30.3 12.4l70.9 70.9c8 8 12.4 18.9 12.4 30.3V464c0 13.3-10.7 24-24 24H112c-13.3 0-24-10.7-24-24V48z"/></svg>',
            'file-pdf': '<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M743.483311 0H109.01234A53.988777 53.988777 0 0 0 55.023562 53.988777v916.009591a53.988777 53.988777 0 0 0 53.988778 53.988778h805.97532a53.988777 53.988777 0 0 0 53.988778-53.988778V211.083265z m-10.913446 102.462987l149.201843 139.702389H732.569865zM137.292176 941.718532V82.268613h513.009076v242.165376h236.419427V941.718532z" p-id="18073"></path><path d="M298.60293 437.86184h-83.258408v237.332094h57.09956v-78.785051h27.752802c50.132436 0 93.837637-24.886256 93.837637-81.343092-0.051418-58.693514-43.113895-77.203952-95.431591-77.203951z m-1.285447 113.569249h-24.873401v-68.591456h23.292301c27.431441 0 42.741115 8.303988 42.741115 32.226158 0 23.279447-13.394359 36.365298-41.147161 36.365298zM502.757635 437.86184H434.487541v237.332094h71.458003c69.221325 0 117.065666-37.277965 117.065666-119.932212s-47.84434-117.399882-120.253575-117.399882z m-3.50927 191.40307h-7.712683V483.160995h7.712683c38.280614 0 65.390693 15.631037 65.390693 72.100727s-27.110079 74.003189-65.390693 74.003188zM667.024918 675.193934h57.099559v-90.585456h81.02173v-47.535833h-81.02173v-51.996334h94.428943v-47.201617H667.024918v237.31924z" p-id="18074"></path></svg>',
            'file-image': '<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M85.312 85.312h853.376v853.376H85.312V85.312z m85.376 768h579.648L384 487.04l-213.312 213.376v152.96z m682.624-17.664V170.688H170.688v408.96L384 366.336l469.312 469.312z m-179.328-526.336a42.688 42.688 0 1 0 0 85.376 42.688 42.688 0 0 0 0-85.376z m-128 42.688a128 128 0 1 1 256 0 128 128 0 0 1-256 0z" p-id="8717"></path></svg>',
            'file-video': '<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="200" height="200"><path d="M960 192l-28.384 0c-16.8 0-32.928 6.624-44.928 18.432l-86.688 85.504 0-39.936c0-53.024-43.008-96-96-96l-608 0c-52.928 0-96 43.04-96 96l0 512c0 52.992 42.976 96 96 96l608 0c52.992 0 96-43.008 96-96l0-39.072 86.688 85.504c12 11.808 28.128 18.432 44.928 18.432l28.384 0c35.328 0 64-28.64 64-64l0-512.864c0-35.36-28.672-64-64-64zM96 800c-17.664 0-32-14.368-32-32l0-512c0-17.696 14.304-32 32-32l608 0c17.632 0 32 14.336 32 32l0 512c0 17.632-14.368 32-32 32l-608 0zM960 768.864l-32 0-128-128 0-0.864-32-32 0-192 160-160 32 0 0 512.864z" fill="#444444" p-id="10699"></path></svg>',
        };

        function renderSvg(key) {
             return SVG_ICONS[key] || `<span style="color:red;">[${key}?]</span>`;
        }

        function getFileIconInfo(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            let iconKey = 'file-regular';
            let colorClass = 'icon-txt';

            switch (ext) {
                case 'pdf': iconKey = 'file-pdf'; colorClass = 'icon-pdf'; break;
                case 'jpg':
                case 'jpeg':
                case 'png':
                case 'gif':
                case 'webp': iconKey = 'file-image'; colorClass = 'icon-img'; break;
                case 'mp4':
                case 'mov':
                case 'avi':
                case 'mkv': iconKey = 'file-video'; colorClass = 'icon-vid'; break;
                default:
                    const codeExtensions = ['js', 'ts', 'html', 'css', 'json', 'py'];
                    if (codeExtensions.includes(ext)) {
                        iconKey = 'file-regular';
                        colorClass = 'icon-code';
                    } else {
                        iconKey = 'file-regular';
                        colorClass = 'icon-txt';
                    }
                    break;
            }
            return { iconKey, colorClass };
        }

        // --- 2. å¼‚æ­¥æ•°æ®åŠ è½½å‡½æ•° ---
        function loadDirectory(path, containerUl) {
            const apiUrl = `https://lbepan.luoboedu.com?path=${encodeURIComponent(path)}`;

            if (!containerUl.dataset.loaded) {
                 containerUl.innerHTML = '<li>åŠ è½½ä¸­...</li>';
            }

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    containerUl.innerHTML = '';

                    if (!data.list || data.list.length === 0) {
                        containerUl.innerHTML = '<li>(ç©º)</li>';
                        return;
                    }

                    data.list.forEach(item => {
                        const li = document.createElement('li');

                        if (item.is_dir) {
                            li.classList.add('folder');
                            const newPath = path.endsWith('/') ? `${path}${item.name}` : `${path}/${item.name}`;
                            li.dataset.path = newPath;

                            const folderIconHtml = renderSvg('folder-regular');

                            li.innerHTML = `
                                <span class="toggle">+</span>
                                <span class="name">
                                    <span class="icon-folder twemoji">${folderIconHtml}</span>
                                    ${item.name || ''}
                                </span>
                                <span class="copy-link" title="å¤åˆ¶é“¾æ¥">ğŸ”—</span>
                                <ul class="nested"></ul>
                            `;
                        } else {
                            const iconInfo = getFileIconInfo(item.name || '');

                            li.classList.add('file');
                            const fileIconHtml = renderSvg(iconInfo.iconKey);

                            li.innerHTML = `
                                <span class="icon ${iconInfo.colorClass} twemoji">
                                    ${fileIconHtml}
                                </span>
                                <span class="name">${item.name || ''}</span>
                                <span class="size">(${item.size || ''})</span>
                            `;
                        }
                        containerUl.appendChild(li);
                    });
                })
                .catch(error => {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    containerUl.innerHTML = `<li style="color: red;">åŠ è½½å¤±è´¥: ${error.message}</li>`;
                });
        }

        // --- 3. å…±äº«äº‹ä»¶å¤„ç†å™¨ ---
        function handleTreeClick(e) {
            const treeContainer = e.currentTarget;

            // 1. å¤„ç† "å¤åˆ¶é“¾æ¥"
            const copyLink = e.target.closest('.copy-link');
            if (copyLink) {
                const li = copyLink.closest('li.folder');
                if (!li) return;
                const path = li.dataset.path;

                // å¤åˆ¶é“¾æ¥é€»è¾‘ä¸å˜
                const url = new URL(window.location.pathname, window.location.origin);
                url.searchParams.set('path', path);
                const shareUrl = url.toString();

                navigator.clipboard.writeText(shareUrl).then(() => {
                    copyLink.textContent = 'âœ…';
                    copyLink.classList.add('copied');
                    setTimeout(() => {
                        copyLink.textContent = 'ğŸ”—';
                        copyLink.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('æ— æ³•å¤åˆ¶é“¾æ¥: ', err);
                    alert('å¤åˆ¶å¤±è´¥!');
                });
                return;
            }

            // 2. å¤„ç† "æŠ˜å /å±•å¼€"
            const targetElement = e.target.closest('.toggle, .name');
            if (!targetElement) return;

            const li = targetElement.closest('li');
            if (!li || !li.classList.contains('folder')) return;

            const toggle = li.querySelector('.toggle');
            const nestedUl = li.querySelector('.nested');
            if (!toggle || !nestedUl) return;

            const isExpanded = li.classList.toggle('expanded');

            if (isExpanded) {
                toggle.textContent = 'âˆ’';
                if (!nestedUl.dataset.loaded) {
                    const path = li.dataset.path;
                    loadDirectory(path, nestedUl);
                    nestedUl.dataset.loaded = 'true';
                }
            } else {
                toggle.textContent = '+';
            }
        }

        // --- 4. æ ¸å¿ƒåˆå§‹åŒ–å‡½æ•° (æ¯æ¬¡å¯¼èˆªéƒ½ä¼šè¿è¡Œ) ---
        function initializeTree() {
            const treeContainer = document.getElementById('tree-container');

            if (!treeContainer) {
                return;
            }

            // ç¡®ä¿äº‹ä»¶åªç»‘å®šä¸€æ¬¡
            if (treeContainer.dataset.eventsBound !== 'true') {
                treeContainer.addEventListener('click', handleTreeClick);
                treeContainer.dataset.eventsBound = 'true';
            }

            // --- å†…å®¹åŠ è½½é€»è¾‘ (æ¯æ¬¡éƒ½éœ€è¦è¿è¡Œ) ---

            // 1. æ¸…ç†å¹¶å‡†å¤‡æ ¹å…ƒç´ 
            treeContainer.innerHTML = '';
            const rootUl = document.createElement('ul');
            treeContainer.appendChild(rootUl);

            // 2. è·å–è·¯å¾„
            const urlParams = new URLSearchParams(window.location.search);
            const initialPath = urlParams.get('path') || '/';

            const pathDisplay = document.getElementById('current-path-display');
            if (pathDisplay) {
                pathDisplay.textContent = initialPath;
            }

            // 3. é¦–æ¬¡åŠ è½½æ ¹ç›®å½•
            loadDirectory(initialPath, rootUl);
        }

        // --- 5. å¯åŠ¨ç‚¹ï¼šç›‘å¬ MkDocs Material çš„ document$ ---

        // MkDocs Material ä¼šåœ¨å†…å®¹æ›¿æ¢å®Œæˆåè§¦å‘ document$
        if (typeof document$ !== 'undefined' && typeof document$.subscribe === 'function') {
            document$.subscribe(function() {
                // åœ¨å†…å®¹åŠ è½½å’Œ DOM æ›¿æ¢å®Œæˆåè¿è¡Œåˆå§‹åŒ–
                initializeTree();
            });
        } else {
            // å¦‚æœ document$ ä¸å­˜åœ¨ (é MkDocs ç¯å¢ƒæˆ–åŠ è½½å¤±è´¥)ï¼Œä½¿ç”¨ DOMContentLoaded ä½œä¸ºå›é€€
            // console.warn("document$ not found. Using DOMContentLoaded.");
            document.addEventListener('DOMContentLoaded', initializeTree);
        }

    })(); // ç«‹å³æ‰§è¡Œå‡½æ•°ç»“æŸ
</script>
{% endblock %}