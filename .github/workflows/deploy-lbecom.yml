name: lbecom MkDocs Deploy

on:
  push:
    branches: [ main, master ]
    paths:
      - 'lbecom/**'
      - '!lbecom/.obsidian/**'  # ä½¿ç”¨!è¡¨ç¤ºæ’é™¤
      - '.github/workflows/deploy-lbecom.yml'

  pull_request:
    branches: [ main, master ]
    paths:
      - 'lbecom/**'

  # æ‰‹åŠ¨è§¦å‘ï¼šéšæ—¶å¯ä»¥ç‚¹å‡»è¿è¡Œ
  workflow_dispatch:
    inputs:
      clean_deploy:
        description: 'æ˜¯å¦æ¸…ç†COSç›®æ ‡ç›®å½•'
        required: false
        default: false
        type: boolean
      deploy_message:
        description: 'éƒ¨ç½²è¯´æ˜'
        required: false
        type: string

env:
  PYTHON_VERSION: '3.13'
  TZ: Asia/Shanghai # è®¾ç½®å½“å‰ç¯å¢ƒæ—¶åŒº
  COS_REGION: "ap-guangzhou"  # COS åŒºåŸŸ
  COS_BUCKET: "lbecom-1251467080"  # ä½ çš„COSæ¡¶åç§°
  COS_PATH: "."  # COSä¸Šçš„ç›®æ ‡è·¯å¾„


jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Sparse checkout lbecom directory
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        sparse-checkout: |
          lbecom/
          .github/workflows/
        sparse-checkout-cone-mode: false

    - name: Show directory structure
      run: |
        echo "ğŸ“ å·¥ä½œç›®å½•ç»“æ„:"
        ls -la
        echo ""
        echo "ğŸ“ lbecomç›®å½•å†…å®¹:"
        ls -la lbecom/ || echo "lbecomç›®å½•ä¸å­˜åœ¨"

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: 'lbecom/requirements.txt'

    - name: Install dependencies
      run: |
        if [ ! -f "lbecom/requirements.txt" ]; then
          echo "âŒ lbecom/requirements.txt ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
        pip install -r lbecom/requirements.txt
      working-directory: ./

    - name: Build MkDocs site
      run: |
        mkdocs build --site-dir public --verbose
      working-directory: ./lbecom

    - name: Install CosCmd CLI (æ¨èæ–¹æ¡ˆ)
      run: |
        pip install coscmd

    - name: Upload to Tencent COS using CosCmd
      run: |
        # é…ç½®coscmd
        coscmd config -a ${{ secrets.COS_SECRET_ID }} -s ${{ secrets.COS_SECRET_KEY }} -b ${{ env.COS_BUCKET }} -r ${{ env.COS_REGION }}
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…ç†ç›®æ ‡ç›®å½•
        if ${{ inputs.clean_deploy == 'true' }}; then
          echo "ğŸ§¹ æ¸…ç†COSç›®æ ‡ç›®å½•: ${{ env.COS_PATH }}"
          coscmd delete -r -f ${{ env.COS_PATH }} || echo "ç›®å½•ä¸å­˜åœ¨æˆ–å·²æ¸…ç©º"
        fi

        echo "ğŸš€ ä¸Šä¼ æ–‡ä»¶åˆ°COS..."
        coscmd upload -r ./lbecom/public/ ${{ env.COS_PATH }} --delete
        
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        echo "è®¿é—®åœ°å€: https://${{ env.COS_BUCKET }}.cos-website.${{ env.COS_REGION }}.myqcloud.com"
        echo "è®¿é—®åœ°å€: https://www.luoboedu.com"
      working-directory: ./

    - name: Deploy Notification
      if: always()
      run: |
        DEPLOY_STATUS=${{ job.status }}
        DEPLOY_MESSAGE=${{ inputs.deploy_message || 'æ— ç‰¹åˆ«è¯´æ˜' }}
        
        echo "ğŸ“¢ éƒ¨ç½²ç»“æœé€šçŸ¥"
        echo "çŠ¶æ€: $DEPLOY_STATUS"
        echo "è¯´æ˜: $DEPLOY_MESSAGE"
        echo "è§¦å‘è€…: ${{ github.actor }}"
        echo "åˆ†æ”¯: ${{ github.ref }}"
        echo "æäº¤: ${{ github.sha }}"